# WAN 2.2 RunPod Template - Custom Dockerfile
# Based on runpod/worker-comfyui with CUDA 12.8.1, PyTorch nightly, and JupyterLab
# Author: AI IDE Agent
# Date: 2025-10-11 (Updated to use PyTorch nightly for CUDA 12.8 support)

# ============================================================================
# Stage 1: Base image with CUDA 12.8.1 and ComfyUI
# ============================================================================
# Using runtime image (smaller) since we're using pre-built SageAttention2 wheel
FROM nvidia/cuda:12.8.1-cudnn-runtime-ubuntu24.04 AS base

# Build arguments
ARG COMFYUI_VERSION=v0.3.55
# Note: Using nightly builds for CUDA 12.8 support (stable version doesn't exist yet)

# Environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PIP_PREFER_BINARY=1
ENV PYTHONUNBUFFERED=1
ENV CMAKE_BUILD_PARALLEL_LEVEL=8

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.12 \
    python3.12-venv \
    git \
    wget \
    curl \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    ffmpeg \
    && ln -sf /usr/bin/python3.12 /usr/bin/python \
    && ln -sf /usr/bin/pip3 /usr/bin/pip

# Clean up to reduce image size
RUN apt-get autoremove -y && apt-get clean -y && rm -rf /var/lib/apt/lists/*

# Install uv (fast Python package installer)
RUN wget -qO- https://astral.sh/uv/install.sh | sh \
    && ln -s /root/.local/bin/uv /usr/local/bin/uv \
    && ln -s /root/.local/bin/uvx /usr/local/bin/uvx \
    && uv venv /opt/venv

# Use the virtual environment
ENV PATH="/opt/venv/bin:${PATH}"

# Install comfy-cli and dependencies
RUN uv pip install comfy-cli pip setuptools wheel

# Install ComfyUI with CUDA 12.8 support
RUN /usr/bin/yes | comfy --workspace /comfyui install --version "${COMFYUI_VERSION}" --nvidia

# Install PyTorch nightly with CUDA 12.8 support
# Using --pre flag to get nightly builds since stable CUDA 12.8 support isn't released yet
RUN uv pip install --pre --force-reinstall \
    torch \
    torchvision \
    torchaudio \
    --index-url https://download.pytorch.org/whl/cu128

# Change to ComfyUI directory
WORKDIR /comfyui

# Support for network volumes
ADD runpod-worker-comfyui/src/extra_model_paths.yaml ./

# Go back to root
WORKDIR /

# Install RunPod handler dependencies
RUN uv pip install runpod requests websocket-client

# ============================================================================
# Stage 2: Install Custom Nodes
# ============================================================================
FROM base AS custom_nodes

WORKDIR /comfyui/custom_nodes

# Install ComfyUI Manager (remove if exists to ensure fresh clone)
RUN rm -rf ComfyUI-Manager && \
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git

# Install WAN Video Wrapper (remove if exists to ensure fresh clone)
RUN rm -rf ComfyUI-WanVideoWrapper && \
    git clone https://github.com/kijai/ComfyUI-WanVideoWrapper.git

# Install WAN Video Wrapper dependencies
RUN uv pip install \
    ftfy \
    accelerate>=1.2.1 \
    einops \
    diffusers>=0.33.0 \
    peft>=0.17.0 \
    sentencepiece>=0.2.0 \
    protobuf \
    pyloudnorm \
    gguf>=0.17.1 \
    opencv-python \
    scipy

# Install additional dependencies for SageAttention
RUN uv pip install \
    wheel \
    setuptools \
    packaging \
    ninja

# Install Triton for SageAttention (Linux version)
RUN uv pip install triton

# ============================================================================
# Stage 3: Install SageAttention2 (pre-built wheel, no compilation needed)
# ============================================================================
FROM custom_nodes AS sageattention

# Install SageAttention2 - pre-built wheel that works with all CUDA architectures
# This is simpler and faster than compiling SageAttention3 from source
RUN echo "Installing SageAttention2..." && \
    uv pip install sageattention

# ============================================================================
# Stage 4: Install JupyterLab
# ============================================================================
FROM sageattention AS jupyter

# Install JupyterLab and related packages
RUN uv pip install \
    jupyterlab \
    notebook \
    ipywidgets \
    matplotlib \
    pandas

# Create JupyterLab configuration directory
RUN mkdir -p /root/.jupyter

# Create JupyterLab config with port 8189
RUN echo "c.ServerApp.ip = '0.0.0.0'" > /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.port = 8189" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.token = ''" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.root_dir = '/comfyui'" >> /root/.jupyter/jupyter_lab_config.py

# ============================================================================
# Stage 5: Final Configuration
# ============================================================================
FROM jupyter AS final

WORKDIR /

# Copy handler and scripts from local runpod-worker-comfyui directory
COPY runpod-worker-comfyui/handler.py /handler.py
COPY runpod-worker-comfyui/src/start.sh /start.sh.original

# Copy model download script
COPY scripts/download_models.sh /scripts/download_models.sh
RUN chmod +x /scripts/download_models.sh

# Create custom start script that launches both ComfyUI and JupyterLab for COMPUTE mode
RUN printf '#!/usr/bin/env bash\n\
\n\
# Use libtcmalloc for better memory management\n\
TCMALLOC="$(ldconfig -p | grep -Po "libtcmalloc.so.\\d" | head -n 1)"\n\
export LD_PRELOAD="${TCMALLOC}"\n\
\n\
echo "WAN 2.2 RunPod Compute Template - Starting services..."\n\
\n\
# Download models on first run (uses persistent /workspace if available)\n\
echo "Checking for WAN 2.2 models..."\n\
/scripts/download_models.sh\n\
\n\
# Start JupyterLab in the background on port 8189\n\
echo "Starting JupyterLab on port 8189..."\n\
jupyter lab --config=/root/.jupyter/jupyter_lab_config.py &\n\
\n\
# Allow operators to tweak verbosity; default is DEBUG\n\
: "${COMFY_LOG_LEVEL:=DEBUG}"\n\
\n\
echo "Starting ComfyUI on port 8188 with SageAttention..."\n\
\n\
# Start ComfyUI with --listen 0.0.0.0 to accept external connections\n\
# CRITICAL: --use-sage-attention flag enables SageAttention3 for Blackwell GPUs\n\
# --listen 0.0.0.0 makes ComfyUI accessible from outside the container\n\
# --port 8188 explicitly sets the port (default but being explicit)\n\
python -u /comfyui/main.py \\\n\
    --disable-auto-launch \\\n\
    --disable-metadata \\\n\
    --listen 0.0.0.0 \\\n\
    --port 8188 \\\n\
    --verbose "${COMFY_LOG_LEVEL}" \\\n\
    --log-stdout \\\n\
    --use-sage-attention\n' > /start.sh

RUN chmod +x /start.sh

# Prevent pip from asking for confirmation
ENV PIP_NO_INPUT=1

# Expose ports
# 8188 - ComfyUI API
# 8189 - JupyterLab
EXPOSE 8188 8189

# Set the default command
CMD ["/start.sh"]

# Labels
LABEL maintainer="WAN 2.2 RunPod Compute Template"
LABEL description="RunPod COMPUTE template for WAN 2.2 with CUDA 12.8, PyTorch nightly, ComfyUI v0.3.55, and JupyterLab. ComfyUI on port 8188, JupyterLab on port 8189."
LABEL cuda.version="12.8.1"
LABEL pytorch.version="nightly"
LABEL comfyui.version="v0.3.55"
LABEL wan.version="2.2"
LABEL template.type="compute"
LABEL ports.comfyui="8188"
LABEL ports.jupyterlab="8189"

